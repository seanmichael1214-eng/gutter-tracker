<!DOCTYPE html>
<html>
<head>
    <title>Quick Estimate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Profile Switcher */
        .profile-switcher {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .profile-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 18px;
            font-weight: bold;
        }
        .profile-tab.florite {
            background: #e8e8e8;
            color: #333;
        }
        .profile-tab.florite.active {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
        }
        .profile-tab.triplebeezy {
            background: #e8e8e8;
            color: #333;
        }
        .profile-tab.triplebeezy.active {
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
            color: white;
        }
        .profile-tab .icon {
            font-size: 24px;
            display: block;
            margin-bottom: 5px;
        }
        
        .estimate-header {
            padding: 20px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }
        .estimate-header.florite {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        }
        .estimate-header.triplebeezy {
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
        }
        .estimate-header h2 {
            margin: 0;
            font-size: 28px;
        }
        .estimate-header .subtitle {
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .camera-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
        }
        .camera-section h3 {
            color: white;
            margin-top: 0;
        }
        .camera-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .camera-btn {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .camera-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .camera-btn.primary {
            background: #fff;
            color: #667eea;
        }
        .camera-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        #videoContainer {
            display: none;
            margin: 15px 0;
            position: relative;
        }
        #video {
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
            background: #000;
        }
        #captureBtn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: rgba(255,255,255,0.3);
            cursor: pointer;
        }
        #captureBtn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
        }
        #previewContainer {
            display: none;
            margin: 15px 0;
        }
        #preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
        }
        
        .settings-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .settings-section h3 {
            margin-top: 0;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .setting-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .setting-item label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 13px;
        }
        .setting-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }
        .setting-item .unit {
            font-size: 11px;
            color: #6c757d;
            margin-top: 3px;
        }
        
        .workflow-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .workflow-section h3 {
            margin-top: 0;
            color: #856404;
        }
        
        .manual-input {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            margin-bottom: 20px;
        }
        .manual-input h3 {
            margin-top: 0;
        }
        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
        }
        
        #estimateResult {
            display: none;
            background: white;
            border: 3px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        #estimateResult h3 {
            color: #28a745;
            margin-top: 0;
        }
        .estimate-breakdown {
            margin: 20px 0;
        }
        .estimate-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .estimate-row:last-child {
            border-bottom: none;
        }
        .estimate-row.total {
            font-weight: bold;
            font-size: 1.2em;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .estimate-row .item {
            color: #495057;
        }
        .estimate-row .qty {
            color: #6c757d;
            font-size: 0.9em;
        }
        .estimate-row .price {
            font-weight: 600;
            color: #28a745;
        }
        
        .profit-section {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }
        .profit-section h4 {
            margin: 0 0 10px 0;
        }
        .profit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }
        .profit-item {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 8px;
        }
        .profit-item .label {
            font-size: 11px;
            opacity: 0.9;
        }
        .profit-item .value {
            font-size: 20px;
            font-weight: bold;
        }
        
        .ai-analysis {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .ai-analysis h4 {
            margin: 0 0 10px 0;
            color: #0c5460;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #667eea;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .action-btn {
            border: none;
            padding: 12px 25px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        .action-btn.save { background: #28a745; color: white; }
        .action-btn.copy { background: #17a2b8; color: white; }
        .action-btn.settings { background: #6c757d; color: white; }
        
        .toggle-btn {
            background: none;
            border: 2px solid #6c757d;
            color: #6c757d;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .toggle-btn:hover {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>Gutter Tracker</h1>
        <ul>
            <li><a href="/">Dashboard</a></li>
            <li><a href="/customers">Customers</a></li>
            <li><a href="/jobs">Jobs</a></li>
            <li><a href="/calendar">Calendar</a></li>
            <li><a href="/inventory">Inventory</a></li>
            <li><a href="/materials">Materials</a></li>
            <li><a href="/quick-estimate" class="active">Quick Estimate</a></li>
            <li><a href="/reports">Reports</a></li>
            <li><a href="/logout">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <!-- Profile Switcher -->
        <div class="profile-switcher">
            <button class="profile-tab florite active" onclick="switchProfile('florite')">
                <span class="icon">üè¢</span>
                Flo-Rite
            </button>
            <button class="profile-tab triplebeezy" onclick="switchProfile('triplebeezy')">
                <span class="icon">üêù</span>
                Triple Beezy
            </button>
        </div>

        <div class="estimate-header florite" id="profileHeader">
            <h2 id="profileTitle">üè¢ Flo-Rite Estimate</h2>
            <p class="subtitle">Snap a photo or enter measurements for instant pricing</p>
        </div>

        <!-- Camera Section -->
        <div class="camera-section">
            <h3>üì∏ AI Photo Estimate</h3>
            <p>Take a photo of the house - no ladder needed!</p>
            
            <div class="camera-buttons">
                <button class="camera-btn primary" onclick="startCamera()">
                    üì∑ Open Camera
                </button>
                <label class="camera-btn secondary">
                    üìÅ Upload Photo
                    <input type="file" accept="image/*" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">
                </label>
            </div>

            <div id="videoContainer">
                <video id="video" autoplay playsinline></video>
                <button id="captureBtn" onclick="capturePhoto()"></button>
                <br>
                <button class="camera-btn secondary" onclick="stopCamera()" style="margin-top: 10px;">‚úï Close</button>
            </div>

            <div id="previewContainer">
                <img id="preview" alt="Captured photo">
                <br>
                <button class="camera-btn primary" onclick="analyzeForEstimate()" style="margin-top: 10px;">ü§ñ Get AI Estimate</button>
                <button class="camera-btn secondary" onclick="clearPreview()" style="margin-top: 10px;">‚úï Clear</button>
            </div>

            <div id="aiAnalysis" class="ai-analysis" style="display: none;">
                <h4>ü§ñ AI Analysis</h4>
                <div id="aiContent"></div>
            </div>
        </div>

        <!-- Workflow Preferences -->
        <button class="toggle-btn" onclick="toggleSection('workflowSection')">üîß My Workflow Preferences</button>
        
        <div class="workflow-section" id="workflowSection" style="display: none;">
            <h3>üîß <span id="workflowProfileName">Flo-Rite</span> Workflow Style</h3>
            <p style="color: #856404; margin-bottom: 15px;">How do YOU install gutters? AI will use these preferences.</p>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <label>Hangers Per Foot</label>
                    <input type="number" id="hangersPerFoot" step="0.1" value="0.5">
                    <div class="unit">e.g., 0.5 = 1 every 2ft</div>
                </div>
                <div class="setting-item">
                    <label>Elbows Per Downspout</label>
                    <input type="number" id="elbowsPerDownspout" value="2">
                    <div class="unit">A + B elbows total</div>
                </div>
                <div class="setting-item">
                    <label>Downspout Length</label>
                    <input type="number" id="downspoutPerStory" value="10">
                    <div class="unit">ft per story</div>
                </div>
                <div class="setting-item">
                    <label>Splash Block Per DS</label>
                    <select id="splashBlockPerDS">
                        <option value="0">None</option>
                        <option value="1" selected>1 each</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Screws Per Hanger</label>
                    <input type="number" id="screwsPerHanger" value="2">
                    <div class="unit">for costing</div>
                </div>
                <div class="setting-item">
                    <label>Caulk Tubes Per 100ft</label>
                    <input type="number" id="caulkPer100" step="0.5" value="1">
                    <div class="unit">sealant usage</div>
                </div>
            </div>
        </div>

        <!-- Pricing Settings -->
        <button class="toggle-btn" onclick="toggleSection('settingsSection')">üí∞ Pricing Settings</button>
        
        <div class="settings-section" id="settingsSection" style="display: none;">
            <h3>üí∞ <span id="pricingProfileName">Flo-Rite</span> Pricing</h3>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <label>Gutter Coil</label>
                    <input type="number" id="gutterCoilCost" step="0.01" value="1.25">
                    <div class="unit">$ per linear ft</div>
                </div>
                <div class="setting-item">
                    <label>Downspout (10ft)</label>
                    <input type="number" id="downspoutCost" step="0.01" value="4.50">
                    <div class="unit">$ per section</div>
                </div>
                <div class="setting-item">
                    <label>Inside Corner</label>
                    <input type="number" id="insideCornerCost" step="0.01" value="3.00">
                    <div class="unit">$ each</div>
                </div>
                <div class="setting-item">
                    <label>Outside Corner</label>
                    <input type="number" id="outsideCornerCost" step="0.01" value="3.00">
                    <div class="unit">$ each</div>
                </div>
                <div class="setting-item">
                    <label>End Cap</label>
                    <input type="number" id="endCapCost" step="0.01" value="1.50">
                    <div class="unit">$ each</div>
                </div>
                <div class="setting-item">
                    <label>Elbow</label>
                    <input type="number" id="elbowCost" step="0.01" value="4.00">
                    <div class="unit">$ each</div>
                </div>
                <div class="setting-item">
                    <label>Outlet/Drop</label>
                    <input type="number" id="outletCost" step="0.01" value="3.50">
                    <div class="unit">$ each</div>
                </div>
                <div class="setting-item">
                    <label>Hanger</label>
                    <input type="number" id="hangerCost" step="0.01" value="0.75">
                    <div class="unit">$ each</div>
                </div>
                <div class="setting-item">
                    <label>Splash Block</label>
                    <input type="number" id="splashBlockCost" step="0.01" value="8.00">
                    <div class="unit">$ each</div>
                </div>
                <div class="setting-item">
                    <label>Gutter Guard</label>
                    <input type="number" id="gutterGuardCost" step="0.01" value="3.50">
                    <div class="unit">$ per ft</div>
                </div>
                <div class="setting-item">
                    <label>Labor Rate</label>
                    <input type="number" id="laborRate" step="0.01" value="6.00">
                    <div class="unit">$ per linear ft</div>
                </div>
                <div class="setting-item">
                    <label>Markup %</label>
                    <input type="number" id="markupPercent" step="1" value="30">
                    <div class="unit">profit margin</div>
                </div>
            </div>
            <button class="action-btn save" onclick="saveSettings()">üíæ Save Settings</button>
        </div>

        <!-- Manual Input Section -->
        <div class="manual-input">
            <h3>üìè Measurements</h3>
            
            <div class="input-row">
                <div class="input-group">
                    <label>Linear Feet</label>
                    <input type="number" id="linearFeet" placeholder="150" oninput="calculateEstimate()">
                </div>
                <div class="input-group">
                    <label>Downspouts</label>
                    <input type="number" id="numDownspouts" placeholder="4" oninput="calculateEstimate()">
                </div>
                <div class="input-group">
                    <label>Stories</label>
                    <input type="number" id="stories" value="1" oninput="calculateEstimate()">
                </div>
            </div>
            
            <div class="input-row">
                <div class="input-group">
                    <label>Inside Corners</label>
                    <input type="number" id="insideCorners" value="0" oninput="calculateEstimate()">
                </div>
                <div class="input-group">
                    <label>Outside Corners</label>
                    <input type="number" id="outsideCorners" value="0" oninput="calculateEstimate()">
                </div>
                <div class="input-group">
                    <label>End Caps</label>
                    <input type="number" id="endCaps" value="0" oninput="calculateEstimate()">
                </div>
            </div>
            
            <div class="input-row">
                <div class="input-group">
                    <label>Extra Elbows</label>
                    <input type="number" id="extraElbows" value="0" oninput="calculateEstimate()">
                </div>
                <div class="input-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="includeGuards" onchange="calculateEstimate()">
                        Gutter Guards
                    </label>
                </div>
                <div class="input-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="includeSplash" checked onchange="calculateEstimate()">
                        Splash Blocks
                    </label>
                </div>
            </div>
        </div>

        <!-- Estimate Result -->
        <div id="estimateResult">
            <h3>üí∞ <span id="estimateProfileName">Flo-Rite</span> Estimate</h3>
            
            <div class="estimate-breakdown" id="breakdownContent"></div>
            
            <div class="profit-section">
                <h4>üìä My Numbers (Private)</h4>
                <div class="profit-grid">
                    <div class="profit-item">
                        <div class="label">Materials</div>
                        <div class="value" id="materialCostDisplay">$0</div>
                    </div>
                    <div class="profit-item">
                        <div class="label">Labor</div>
                        <div class="value" id="laborCostDisplay">$0</div>
                    </div>
                    <div class="profit-item">
                        <div class="label">Profit</div>
                        <div class="value" id="profitDisplay">$0</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <button class="action-btn copy" onclick="copyEstimate()">üìÑ Copy Estimate</button>
                <button class="action-btn save" onclick="saveEstimateToJob()">üìã Save to Job</button>
            </div>
        </div>
    </div>

    <script>
        let stream = null;
        let capturedImageData = null;
        let currentProfile = 'florite';

        // Default settings for each profile
        const defaultSettings = {
            florite: {
                // Workflow
                hangersPerFoot: 0.5,
                elbowsPerDownspout: 2,
                downspoutPerStory: 10,
                splashBlockPerDS: 1,
                screwsPerHanger: 2,
                caulkPer100: 1,
                // Pricing
                gutterCoilCost: 1.50,
                downspoutCost: 5.00,
                insideCornerCost: 3.50,
                outsideCornerCost: 3.50,
                endCapCost: 2.00,
                elbowCost: 4.50,
                outletCost: 4.00,
                hangerCost: 0.85,
                splashBlockCost: 10.00,
                gutterGuardCost: 4.00,
                laborRate: 7.00,
                markupPercent: 25
            },
            triplebeezy: {
                // Workflow
                hangersPerFoot: 0.5,
                elbowsPerDownspout: 2,
                downspoutPerStory: 10,
                splashBlockPerDS: 1,
                screwsPerHanger: 2,
                caulkPer100: 1,
                // Pricing (side job rates - higher markup)
                gutterCoilCost: 1.25,
                downspoutCost: 4.50,
                insideCornerCost: 3.00,
                outsideCornerCost: 3.00,
                endCapCost: 1.50,
                elbowCost: 4.00,
                outletCost: 3.50,
                hangerCost: 0.75,
                splashBlockCost: 8.00,
                gutterGuardCost: 3.50,
                laborRate: 8.00,
                markupPercent: 40
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateProfileUI();
        });

        function switchProfile(profile) {
            // Save current settings before switching
            saveSettingsToStorage();
            
            currentProfile = profile;
            
            // Update tab styling
            document.querySelectorAll('.profile-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.profile-tab.${profile}`).classList.add('active');
            
            // Load new profile settings
            loadSettings();
            updateProfileUI();
            calculateEstimate();
        }

        function updateProfileUI() {
            const header = document.getElementById('profileHeader');
            const title = document.getElementById('profileTitle');
            const workflowName = document.getElementById('workflowProfileName');
            const pricingName = document.getElementById('pricingProfileName');
            const estimateName = document.getElementById('estimateProfileName');
            
            header.className = 'estimate-header ' + currentProfile;
            
            if (currentProfile === 'florite') {
                title.textContent = 'üè¢ Flo-Rite Estimate';
                workflowName.textContent = 'Flo-Rite';
                pricingName.textContent = 'Flo-Rite';
                estimateName.textContent = 'Flo-Rite';
            } else {
                title.textContent = 'üêù Triple Beezy Estimate';
                workflowName.textContent = 'Triple Beezy';
                pricingName.textContent = 'Triple Beezy';
                estimateName.textContent = 'Triple Beezy';
            }
        }

        function loadSettings() {
            const storageKey = `gutterEstimate_${currentProfile}`;
            const saved = JSON.parse(localStorage.getItem(storageKey) || 'null');
            const settings = saved || defaultSettings[currentProfile];
            
            // Workflow
            document.getElementById('hangersPerFoot').value = settings.hangersPerFoot;
            document.getElementById('elbowsPerDownspout').value = settings.elbowsPerDownspout;
            document.getElementById('downspoutPerStory').value = settings.downspoutPerStory;
            document.getElementById('splashBlockPerDS').value = settings.splashBlockPerDS;
            document.getElementById('screwsPerHanger').value = settings.screwsPerHanger;
            document.getElementById('caulkPer100').value = settings.caulkPer100;
            
            // Pricing
            document.getElementById('gutterCoilCost').value = settings.gutterCoilCost;
            document.getElementById('downspoutCost').value = settings.downspoutCost;
            document.getElementById('insideCornerCost').value = settings.insideCornerCost;
            document.getElementById('outsideCornerCost').value = settings.outsideCornerCost;
            document.getElementById('endCapCost').value = settings.endCapCost;
            document.getElementById('elbowCost').value = settings.elbowCost;
            document.getElementById('outletCost').value = settings.outletCost;
            document.getElementById('hangerCost').value = settings.hangerCost;
            document.getElementById('splashBlockCost').value = settings.splashBlockCost;
            document.getElementById('gutterGuardCost').value = settings.gutterGuardCost;
            document.getElementById('laborRate').value = settings.laborRate;
            document.getElementById('markupPercent').value = settings.markupPercent;
        }

        function saveSettingsToStorage() {
            const storageKey = `gutterEstimate_${currentProfile}`;
            const settings = {
                hangersPerFoot: parseFloat(document.getElementById('hangersPerFoot').value),
                elbowsPerDownspout: parseFloat(document.getElementById('elbowsPerDownspout').value),
                downspoutPerStory: parseFloat(document.getElementById('downspoutPerStory').value),
                splashBlockPerDS: parseFloat(document.getElementById('splashBlockPerDS').value),
                screwsPerHanger: parseFloat(document.getElementById('screwsPerHanger').value),
                caulkPer100: parseFloat(document.getElementById('caulkPer100').value),
                gutterCoilCost: parseFloat(document.getElementById('gutterCoilCost').value),
                downspoutCost: parseFloat(document.getElementById('downspoutCost').value),
                insideCornerCost: parseFloat(document.getElementById('insideCornerCost').value),
                outsideCornerCost: parseFloat(document.getElementById('outsideCornerCost').value),
                endCapCost: parseFloat(document.getElementById('endCapCost').value),
                elbowCost: parseFloat(document.getElementById('elbowCost').value),
                outletCost: parseFloat(document.getElementById('outletCost').value),
                hangerCost: parseFloat(document.getElementById('hangerCost').value),
                splashBlockCost: parseFloat(document.getElementById('splashBlockCost').value),
                gutterGuardCost: parseFloat(document.getElementById('gutterGuardCost').value),
                laborRate: parseFloat(document.getElementById('laborRate').value),
                markupPercent: parseFloat(document.getElementById('markupPercent').value)
            };
            localStorage.setItem(storageKey, JSON.stringify(settings));
        }

        function saveSettings() {
            saveSettingsToStorage();
            const name = currentProfile === 'florite' ? 'Flo-Rite' : 'Triple Beezy';
            alert(`${name} settings saved! ‚úÖ`);
        }

        function toggleSection(id) {
            const section = document.getElementById(id);
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function calculateEstimate() {
            const linearFeet = parseFloat(document.getElementById('linearFeet').value) || 0;
            const numDownspouts = parseFloat(document.getElementById('numDownspouts').value) || 0;
            const stories = parseFloat(document.getElementById('stories').value) || 1;
            const insideCorners = parseFloat(document.getElementById('insideCorners').value) || 0;
            const outsideCorners = parseFloat(document.getElementById('outsideCorners').value) || 0;
            const endCaps = parseFloat(document.getElementById('endCaps').value) || 0;
            const extraElbows = parseFloat(document.getElementById('extraElbows').value) || 0;
            const includeGuards = document.getElementById('includeGuards').checked;
            const includeSplash = document.getElementById('includeSplash').checked;

            if (linearFeet === 0) {
                document.getElementById('estimateResult').style.display = 'none';
                return;
            }

            // Get workflow preferences
            const hangersPerFoot = parseFloat(document.getElementById('hangersPerFoot').value);
            const elbowsPerDownspout = parseFloat(document.getElementById('elbowsPerDownspout').value);
            const downspoutPerStory = parseFloat(document.getElementById('downspoutPerStory').value);
            const splashBlockPerDS = parseFloat(document.getElementById('splashBlockPerDS').value);

            // Get pricing
            const gutterCoilCost = parseFloat(document.getElementById('gutterCoilCost').value);
            const downspoutCost = parseFloat(document.getElementById('downspoutCost').value);
            const insideCornerCost = parseFloat(document.getElementById('insideCornerCost').value);
            const outsideCornerCost = parseFloat(document.getElementById('outsideCornerCost').value);
            const endCapCost = parseFloat(document.getElementById('endCapCost').value);
            const elbowCost = parseFloat(document.getElementById('elbowCost').value);
            const outletCost = parseFloat(document.getElementById('outletCost').value);
            const hangerCost = parseFloat(document.getElementById('hangerCost').value);
            const splashBlockCost = parseFloat(document.getElementById('splashBlockCost').value);
            const gutterGuardCost = parseFloat(document.getElementById('gutterGuardCost').value);
            const laborRate = parseFloat(document.getElementById('laborRate').value);
            const markupPercent = parseFloat(document.getElementById('markupPercent').value);

            // Calculate quantities based on workflow
            const hangers = Math.ceil(linearFeet * hangersPerFoot);
            const downspoutFeet = numDownspouts * stories * downspoutPerStory;
            const downspoutSections = Math.ceil(downspoutFeet / 10);
            const elbows = (numDownspouts * elbowsPerDownspout) + extraElbows;
            const outlets = numDownspouts;
            const splashBlocks = includeSplash ? (numDownspouts * splashBlockPerDS) : 0;

            // Calculate costs
            const gutterMaterial = linearFeet * gutterCoilCost;
            const downspoutMaterial = downspoutSections * downspoutCost;
            const insideCornerMaterial = insideCorners * insideCornerCost;
            const outsideCornerMaterial = outsideCorners * outsideCornerCost;
            const endCapMaterial = endCaps * endCapCost;
            const elbowMaterial = elbows * elbowCost;
            const outletMaterial = outlets * outletCost;
            const hangerMaterial = hangers * hangerCost;
            const splashBlockMaterial = splashBlocks * splashBlockCost;
            const guardMaterial = includeGuards ? (linearFeet * gutterGuardCost) : 0;

            const totalMaterial = gutterMaterial + downspoutMaterial + insideCornerMaterial + 
                                  outsideCornerMaterial + endCapMaterial + elbowMaterial + 
                                  outletMaterial + hangerMaterial + splashBlockMaterial + guardMaterial;

            const laborCost = linearFeet * laborRate;
            const subtotal = totalMaterial + laborCost;
            const markup = subtotal * (markupPercent / 100);
            const total = subtotal + markup;

            // Build breakdown HTML
            let breakdown = '';
            breakdown += `<div class="estimate-row"><span class="item">Gutter (${linearFeet}ft)</span><span class="price">$${gutterMaterial.toFixed(2)}</span></div>`;
            breakdown += `<div class="estimate-row"><span class="item">Downspouts (${downspoutSections} pcs)</span><span class="price">$${downspoutMaterial.toFixed(2)}</span></div>`;
            breakdown += `<div class="estimate-row"><span class="item">Hangers (${hangers})</span><span class="price">$${hangerMaterial.toFixed(2)}</span></div>`;
            breakdown += `<div class="estimate-row"><span class="item">Elbows (${elbows})</span><span class="price">$${elbowMaterial.toFixed(2)}</span></div>`;
            breakdown += `<div class="estimate-row"><span class="item">Outlets (${outlets})</span><span class="price">$${outletMaterial.toFixed(2)}</span></div>`;
            
            if (insideCorners > 0) breakdown += `<div class="estimate-row"><span class="item">Inside Corners (${insideCorners})</span><span class="price">$${insideCornerMaterial.toFixed(2)}</span></div>`;
            if (outsideCorners > 0) breakdown += `<div class="estimate-row"><span class="item">Outside Corners (${outsideCorners})</span><span class="price">$${outsideCornerMaterial.toFixed(2)}</span></div>`;
            if (endCaps > 0) breakdown += `<div class="estimate-row"><span class="item">End Caps (${endCaps})</span><span class="price">$${endCapMaterial.toFixed(2)}</span></div>`;
            if (splashBlocks > 0) breakdown += `<div class="estimate-row"><span class="item">Splash Blocks (${splashBlocks})</span><span class="price">$${splashBlockMaterial.toFixed(2)}</span></div>`;
            if (includeGuards) breakdown += `<div class="estimate-row"><span class="item">Gutter Guards (${linearFeet}ft)</span><span class="price">$${guardMaterial.toFixed(2)}</span></div>`;
            
            breakdown += `<div class="estimate-row"><span class="item">Labor</span><span class="price">$${laborCost.toFixed(2)}</span></div>`;
            breakdown += `<div class="estimate-row total"><span class="item">TOTAL</span><span class="price">$${total.toFixed(2)}</span></div>`;

            document.getElementById('breakdownContent').innerHTML = breakdown;
            document.getElementById('materialCostDisplay').textContent = '$' + totalMaterial.toFixed(2);
            document.getElementById('laborCostDisplay').textContent = '$' + laborCost.toFixed(2);
            document.getElementById('profitDisplay').textContent = '$' + markup.toFixed(2);
            document.getElementById('estimateResult').style.display = 'block';
        }

        // Camera functions
        function startCamera() {
            const video = document.getElementById('video');
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
            })
            .then(function(s) {
                stream = s;
                video.srcObject = stream;
                document.getElementById('videoContainer').style.display = 'block';
            })
            .catch(function(err) {
                alert('Camera error: ' + err.message);
            });
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('videoContainer').style.display = 'none';
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('preview').src = capturedImageData;
            document.getElementById('previewContainer').style.display = 'block';
            stopCamera();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                capturedImageData = e.target.result;
                document.getElementById('preview').src = capturedImageData;
                document.getElementById('previewContainer').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function clearPreview() {
            capturedImageData = null;
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('aiAnalysis').style.display = 'none';
        }

        function analyzeForEstimate() {
            if (!capturedImageData) return alert('Take a photo first');

            const aiAnalysis = document.getElementById('aiAnalysis');
            const aiContent = document.getElementById('aiContent');
            
            aiAnalysis.style.display = 'block';
            aiContent.innerHTML = '<div class="loading">AI analyzing...</div>';

            fetch('/api/ai/estimate-from-photo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ photo_data: capturedImageData })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    aiContent.innerHTML = `<div style="white-space: pre-wrap;">${data.analysis}</div>`;
                    if (data.measurements) {
                        if (data.measurements.linearFeet) document.getElementById('linearFeet').value = data.measurements.linearFeet;
                        if (data.measurements.downspouts) document.getElementById('numDownspouts').value = data.measurements.downspouts;
                        if (data.measurements.stories) document.getElementById('stories').value = data.measurements.stories;
                        if (data.measurements.insideCorners) document.getElementById('insideCorners').value = data.measurements.insideCorners;
                        if (data.measurements.outsideCorners) document.getElementById('outsideCorners').value = data.measurements.outsideCorners;
                        calculateEstimate();
                    }
                } else {
                    aiContent.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                }
            })
            .catch(e => aiContent.innerHTML = `<p style="color:red;">Error: ${e.message}</p>`);
        }

        function copyEstimate() {
            const name = currentProfile === 'florite' ? 'Flo-Rite Gutters' : 'Triple Beezy';
            const total = document.querySelector('.estimate-row.total .price').textContent;
            const breakdown = document.getElementById('breakdownContent').innerText;
            
            const text = `${name} ESTIMATE\n${'='.repeat(25)}\n${breakdown}\n\nContact us to schedule!`;
            
            navigator.clipboard.writeText(text).then(() => alert('Copied! üìã'));
        }

        function saveEstimateToJob() {
            alert('Coming soon - will create a job with this estimate!');
        }
    </script>

    <!-- Floating Help Button -->
    <a href="/help" class="help-fab" title="Get Help">‚ùì</a>
</body>
</html>
